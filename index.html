<template>
  <div class="login-container">
    <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>

    <form @submit.prevent="login">
      <div>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="text" v-model="form.username" />
      </div>

      <div>
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input :type="showPassword ? 'text' : 'password'" v-model="form.password" />
        <button type="button" @click="showPassword = !showPassword">
          {{ showPassword ? '‡∏ã‡πà‡∏≠‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á' }}
        </button>
      </div>

  <div class="form-group">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
    <select v-model="selectedRole">
      <option disabled value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
      <option v-for="role in roles" :key="role.id" :value="role.name">
        {{ role.name }}
      </option>
    </select>

    <p>‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {{ selectedRole }}</p>
  </div>


      <button type="submit" :disabled="loading">
        {{ loading ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..." : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" }}
      </button>

      <p v-if="errorMessage" style="color:red">{{ errorMessage }}</p>
    </form>
  </div>
</template>

<script setup>
import { reactive, ref } from "vue";
import axios from "axios";
import { useRouter } from "vue-router";

const roles = [
  { id: 1, name: 'Admin' },
  { id: 2, name: 'Evaluator' },
  { id: 3, name: 'Employee' },
];
const selectedRole = ref(''); 
const router = useRouter();

const form = reactive({
  username: "",
  password: "",
});

const showPassword = ref(false);
const loading = ref(false);
const errorMessage = ref("");

async function login() {
  loading.value = true;
  errorMessage.value = "";

  try {
    const res = await axios.post("http://localhost:7000/api/auth/login", {
      username: form.username,
      password: form.password,
    });

    const data = res.data;
    console.log("Login result:", data);

    // üëâ ‡πÄ‡∏Å‡πá‡∏ö token
    localStorage.setItem("token", data.accessToken);

    if (data.user) {
      localStorage.setItem("user", JSON.stringify(data.user));
    }

    // üëâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ
    if (data.role === "admin") {
      router.push({ name: "indexadmin" });
    } else if (data.role === "Evaluator") {
      router.push({ name: "indexEmtor" });
    } else if (data.role === "Employee") {
      router.push({ name: "indexEmyee" });
    } else {
      router.push("/");
    }
  } catch (err) {
    // ‡∏ñ‡πâ‡∏≤ API error
    if (err.response?.data?.message) {
      errorMessage.value = err.response.data.message;
    } else {
      errorMessage.value = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ";
    }
  } finally {
    loading.value = false;
  }
}
</script>

<style>
.login-container {
  width: 350px;
  margin: 40px auto;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 6px;
}

.form-group {
  margin-bottom: 16px;
}
select {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

</style>

